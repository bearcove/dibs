tests (
    {
        name "table completions after from"
        input "from |"
        completions {has (product product_variant variant_price product_source product_translation)}
    }

    {
        name "table completions with prefix"
        input "from prod|"
        completions {
            has (product product_variant product_source product_translation)
        }
    }

    {
        name "context-aware column completions in select"
        input <<STYX
            AllProducts @select{
                from product
                fields {|}
            }
            STYX
        completions {
            has (id handle status active metadata created_at updated_at deleted_at)
        }
    }

    {
        name "column completions with prefix"
        input <<STYX
            AllProducts @select{
                from product
                fields {ha|}
            }
            STYX
        completions {
            has (handle)
        }
    }

    {
        name "column completions in where clause"
        input <<STYX
            AllProducts @select{
                from product
                where {|}
            }
            STYX
        completions {
            has (id handle status active metadata created_at updated_at deleted_at)
        }
    }

    {
        name "column completions in order-by"
        input <<STYX
            AllProducts @select{
                from product
                order-by {|}
            }
            STYX
        completions {
            has (id handle status active created_at updated_at)
        }
    }

    {
        name "inlay hints show column types"
        input <<STYX
            AllProducts @select{
                from product
                fields {
                    id
                    handle
                    active
                }
            }
            STYX
        inlay_hints {
            count 3
            has (
                {label ": BIGINT", line 4}
                {label ": TEXT", line 5}
                {label ": BOOLEAN", line 6}
            )
        }
    }

    {
        name "inlay hints appear on correct lines with multiple queries"
        input <<STYX
            FirstQuery @select{
                from product
                fields {
                    id
                    handle
                }
            }
            SecondQuery @select{
                from product_variant
                fields {
                    id
                    sku
                    title
                }
            }
            STYX
        inlay_hints {
            count 5
            has (
                {label ": BIGINT", line 4}
                {label ": TEXT", line 5}
                {label ": BIGINT", line 11}
                {label ": TEXT", line 12}
                {label ": TEXT", line 13}
            )
        }
    }

    {
        name "inlay hints in order-by block"
        input <<STYX
            AllProducts @select{
                from product
                where {deleted_at @null}
                order-by {
                    id asc
                    created_at desc
                }
                fields {id}
            }
            STYX
        inlay_hints {
            count 4
            has (
                {label ": TIMESTAMPTZ", line 3}
                {label ": BIGINT", line 5}
                {label ": TIMESTAMPTZ", line 6}
                {label ": BIGINT", line 8}
            )
        }
    }

    {
        name "inlay hints in where block"
        input <<STYX
            ProductById @select{
                from product
                where {
                    deleted_at @null
                    active true
                    id 123
                }
                fields {handle}
            }
            STYX
        inlay_hints {
            count 4
            has (
                {label ": TIMESTAMPTZ", line 4}
                {label ": BOOLEAN", line 5}
                {label ": BIGINT", line 6}
                {label ": TEXT", line 8}
            )
        }
    }

    {
        name "inlay hints in insert values block"
        input <<STYX
            CreateProduct @insert{
                into product
                values {
                    handle
                    active
                    status
                }
            }
            STYX
        inlay_hints {
            count 3
            has (
                {label ": TEXT", line 4}
                {label ": BOOLEAN", line 5}
                {label ": TEXT", line 6}
            )
        }
    }

    {
        name "inlay hints in update set block"
        input <<STYX
            UpdateProduct @update{
                table product
                set {
                    handle
                    active
                }
                where {id 1}
            }
            STYX
        inlay_hints {
            count 3
            has (
                {label ": TEXT", line 4}
                {label ": BOOLEAN", line 5}
                {label ": BIGINT", line 7}
            )
        }
    }

    {
        name "inlay hints skip explicit type annotations"
        input <<STYX
            CreateProduct @insert{
                into product
                params {new_handle @string}
                values {
                    handle TEXT
                    active BOOLEAN
                }
            }
            STYX
        inlay_hints {
            count 0
        }
    }

    {
        name "inlay hints show for param references"
        input <<STYX
            CreateProduct @insert{
                into product
                params {h @string}
                values {
                    handle $h
                    active true
                }
            }
            STYX
        inlay_hints {
            count 2
            has (
                {label ": TEXT", line 5}
                {label ": BOOLEAN", line 6}
            )
        }
    }

    {
        name "hover on table shows columns"
        input <<STYX
            AllProducts @select{
                from prod|uct
            }
            STYX
        hover {
            contains ("Table `product`" "id" "handle" "status" "active")
        }
    }

    {
        name "hover on column shows type info"
        input <<STYX
            AllProducts @select{
                from product
                fields {han|dle}
            }
            STYX
        hover {
            contains ("Column `product.handle`" "Type:" "TEXT")
        }
    }

    {
        name "diagnostic for unknown table"
        input <<STYX
            AllProducts @select{
                from nonexistent_table
            }
            STYX
        diagnostics {
            has ({message "Unknown table 'nonexistent_table'"})
        }
    }

    {
        name "diagnostic for unknown column"
        input <<STYX
            AllProducts @select{
                from product
                where {deleted_at @null}
                fields {
                    id
                    nonexistent_column
                }
            }
            STYX
        diagnostics {
            count 1
            has ({message "Unknown column 'nonexistent_column'"})
        }
    }

    {
        name "no diagnostics for valid query"
        input <<STYX
            AllProducts @select{
                from product
                where {deleted_at @null}
                fields {
                    id
                    handle
                }
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "definition: param reference jumps to declaration"
        input <<STYX
            ProductByHandle @select{
                from product
                params {
                    handle TEXT
                }
                where {
                    deleted_at @null
                    handle @eq($han|dle)
                }
                fields {id handle}
            }
            STYX
        definition {
            count 1
            has ({line 4})
        }
    }

    {
        name "definition: no result for non-param"
        input <<STYX
            AllProducts @select{
                from product
                where {deleted_at @null}
                fields {han|dle}
            }
            STYX
        definition {
            empty true
        }
    }

    // ========================================================================
    // Query Linting Tests
    // ========================================================================

    {
        name "lint: offset without limit"
        input <<STYX
            BadQuery @select{
                from product
                where {deleted_at @null}
                offset 10
                fields {id}
            }
            STYX
        diagnostics {
            count 1
            has ({message "without 'limit'", code "offset-without-limit"})
        }
    }

    {
        name "lint: limit without order-by"
        input <<STYX
            BadQuery @select{
                from product
                where {deleted_at @null}
                limit 10
                fields {id}
            }
            STYX
        diagnostics {
            count 1
            has ({message "without 'order-by'", code "limit-without-order-by"})
        }
    }

    {
        name "lint: first without order-by"
        input <<STYX
            BadQuery @select{
                from product
                where {deleted_at @null}
                first true
                fields {id}
            }
            STYX
        diagnostics {
            count 1
            has ({message "without 'order-by'", code "first-without-order-by"})
        }
    }

    {
        name "lint: no warning when limit has order-by"
        input <<STYX
            GoodQuery @select{
                from product
                where {deleted_at @null}
                order-by {id asc}
                limit 10
                fields {id}
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: update without where"
        input <<STYX
            DangerousUpdate @update{
                table product
                set {status "deleted"}
            }
            STYX
        diagnostics {
            has ({message "without 'where'", code "mutation-without-where"})
        }
    }

    {
        name "lint: delete without where"
        input <<STYX
            DangerousDelete @delete{
                from product
            }
            STYX
        diagnostics {
            has ({message "without 'where'", code "mutation-without-where"})
        }
    }

    {
        name "lint: no warning when update has where"
        input <<STYX
            SafeUpdate @update{
                table product
                set {status "active"}
                where {id 1}
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: unused param"
        input <<STYX
            BadQuery @select{
                from product
                where {deleted_at @null}
                params {
                    unused_param @string
                }
                fields {id}
            }
            STYX
        diagnostics {
            count 1
            has ({message "never used", code "unused-param"})
        }
    }

    {
        name "lint: no warning when param is used"
        input <<STYX
            GoodQuery @select{
                from product
                params {
                    h @string
                }
                where {deleted_at @null, handle $h}
                fields {id}
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: missing deleted_at filter"
        input <<STYX
            BadQuery @select{
                from product
                fields {id}
            }
            STYX
        diagnostics {
            count 1
            has ({message "doesn't filter 'deleted_at'", code "missing-deleted-at-filter"})
        }
    }

    {
        name "lint: no warning when deleted_at is filtered"
        input <<STYX
            GoodQuery @select{
                from product
                where {deleted_at @null}
                fields {id}
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: hard delete on soft-delete table"
        input <<STYX
            BadDelete @delete{
                from product
                where {id 1}
            }
            STYX
        diagnostics {
            count 1
            has ({message "consider soft delete", code "hard-delete-on-soft-delete-table"})
        }
    }

    {
        name "lint: relation first without order-by"
        input <<STYX
            QueryWithRel @select{
                from product
                where {deleted_at @null}
                fields {
                    id
                    translation @rel{
                        from product_translation
                        first true
                        fields {title}
                    }
                }
            }
            STYX
        diagnostics {
            count 1
            has ({message "@rel without 'order-by'", code "rel-first-without-order-by"})
        }
    }

    {
        name "lint: no warning when relation has order-by"
        input <<STYX
            QueryWithRel @select{
                from product
                where {deleted_at @null}
                fields {
                    id
                    translation @rel{
                        from product_translation
                        order-by {locale asc}
                        first true
                        fields {title}
                    }
                }
            }
            STYX
        diagnostics {
            count 0
        }
    }

    // ========================================================================
    // Type Checking Tests
    // ========================================================================

    {
        name "lint: param type matches column type (string)"
        input <<STYX
            GoodQuery @select{
                from product
                params {h @string}
                where {deleted_at @null, handle $h}
                fields {id}
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: param type matches column type (int)"
        input <<STYX
            GoodQuery @select{
                from product
                params {i @int}
                where {deleted_at @null, id $i}
                fields {id}
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: param type mismatch - int param for text column"
        input <<STYX
            BadQuery @select{
                from product
                params {h @int}
                where {deleted_at @null, handle $h}
                fields {id}
            }
            STYX
        diagnostics {
            count 1
            has ({message "type mismatch", code "param-type-mismatch"})
        }
    }

    {
        name "lint: param type mismatch - string param for bigint column"
        input <<STYX
            BadQuery @select{
                from product
                params {i @string}
                where {deleted_at @null, id $i}
                fields {id}
            }
            STYX
        diagnostics {
            count 1
            has ({message "type mismatch", code "param-type-mismatch"})
        }
    }

    {
        name "lint: param type mismatch with operator"
        input <<STYX
            BadQuery @select{
                from product
                params {id @string}
                where {deleted_at @null, id @eq($id)}
                fields {id}
            }
            STYX
        diagnostics {
            count 1
            has ({message "type mismatch", code "param-type-mismatch"})
        }
    }

    {
        name "lint: literal string matches text column"
        input <<STYX
            GoodQuery @select{
                from product
                where {deleted_at @null, handle "test"}
                fields {id}
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: literal boolean matches boolean column"
        input <<STYX
            GoodQuery @select{
                from product
                where {deleted_at @null, active true}
                fields {id}
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: literal integer matches bigint column"
        input <<STYX
            GoodQuery @select{
                from product
                where {deleted_at @null, id 123}
                fields {id}
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: literal string for boolean column"
        input <<STYX
            BadQuery @select{
                from product
                where {deleted_at @null, active "yes"}
                fields {id}
            }
            STYX
        diagnostics {
            count 1
            has ({message "type mismatch", code "literal-type-mismatch"})
        }
    }

    {
        name "lint: literal boolean for text column"
        input <<STYX
            BadQuery @select{
                from product
                where {deleted_at @null, handle true}
                fields {id}
            }
            STYX
        diagnostics {
            count 1
            has ({message "type mismatch", code "literal-type-mismatch"})
        }
    }

    // ========================================================================
    // FK Relationship Tests
    // ========================================================================

    {
        name "lint: valid FK relationship (product -> product_translation)"
        input <<STYX
            GoodQuery @select{
                from product
                where {deleted_at @null}
                fields {
                    id
                    translation @rel{
                        from product_translation
                        fields {title}
                    }
                }
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: valid FK relationship (product_variant -> variant_price)"
        input <<STYX
            GoodQuery @select{
                from product_variant
                where {deleted_at @null}
                fields {
                    id
                    prices @rel{
                        from variant_price
                        fields {amount, currency_code}
                    }
                }
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: no FK relationship error"
        input <<STYX
            BadQuery @select{
                from product
                where {deleted_at @null}
                fields {
                    id
                    prices @rel{
                        from variant_price
                        fields {amount}
                    }
                }
            }
            STYX
        diagnostics {
            count 1
            has ({message "no FK relationship", code "no-fk-relationship"})
        }
    }

    {
        name "lint: no FK relationship between unrelated tables"
        input <<STYX
            BadQuery @select{
                from product_source
                fields {
                    id
                    translations @rel{
                        from product_translation
                        fields {title}
                    }
                }
            }
            STYX
        diagnostics {
            count 1
            has ({message "no FK relationship", code "no-fk-relationship"})
        }
    }

    // ========================================================================
    // Additional Lint Tests
    // ========================================================================

    {
        name "lint: large offset warning"
        input <<STYX
            BadQuery @select{
                from product
                where {deleted_at @null}
                order-by {id asc}
                offset 5000
                limit 10
                fields {id}
            }
            STYX
        diagnostics {
            count 1
            has ({message "large offset", code "large-offset"})
        }
    }

    {
        name "lint: no warning for small offset"
        input <<STYX
            GoodQuery @select{
                from product
                where {deleted_at @null}
                order-by {id asc}
                offset 100
                limit 10
                fields {id}
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: empty select block"
        input <<STYX
            BadQuery @select{
                from product
                where {deleted_at @null}
                fields {}
            }
            STYX
        diagnostics {
            count 1
            has ({message "empty select", code "empty-select"})
        }
    }

    // ========================================================================
    // Redundant Param Tests
    // ========================================================================

    {
        name "lint: redundant param reference in values"
        input <<STYX
            InsertProduct @insert{
                into product
                params {handle @string}
                values {handle $handle}
            }
            STYX
        diagnostics {
            count 1
            has ({message "can be shortened", code "redundant-param"})
        }
    }

    {
        name "lint: redundant param diagnostic appears on correct line"
        input <<STYX
            InsertProduct @insert{
                into product
                params {handle @string, status @string}
                values {
                    handle $handle
                    status $status
                }
            }
            STYX
        diagnostics {
            count 2
            has (
                {message "handle $handle", code "redundant-param", line 5}
                {message "status $status", code "redundant-param", line 6}
            )
        }
    }

    // ========================================================================
    // Code Action Tests
    // ========================================================================

    {
        name "code action: shorten redundant param"
        input <<STYX
            InsertProduct @insert{
                into product
                params {handle @string}
                values {handle $han|dle}
            }
            STYX
        code_actions {
            count 1
            has ({title "Shorten to", kind "quickfix", preferred true})
        }
    }

    {
        name "code action: no actions for valid code"
        input <<STYX
            GoodQuery @select{
                from product
                params {h @string}
                where {deleted_at @null, handle $h|}
                fields {id}
            }
            STYX
        code_actions {
            empty true
        }
    }

    {
        name "code action: no actions when cursor not on diagnostic (negative test)"
        expect_fail true
        input <<STYX
            InsertProduct @insert{
                into product
                params {handle @string|}
                values {handle $handle}
            }
            STYX
        code_actions {
            has ({title "Shorten"})
        }
    }

    // ========================================================================
    // Inlay Hint Position Tests
    // ========================================================================

    {
        name "inlay hint: wrong column is detected (negative test)"
        expect_fail true
        input <<STYX
            AllProducts @select{
                from product
                fields {
                    id
                }
            }
            STYX
        inlay_hints {
            has ({label ": BIGINT", line 4, col 999})
        }
    }

    // ========================================================================
    // Span Marker Tests (diagnostic range verification)
    // ========================================================================

    {
        name "span marker: unknown table has correct span"
        input <<STYX
            BadQuery @select{
                from nonexistent
                     ^^^^^^^^^^^ "Unknown table"
            }
            STYX
    }

    {
        name "span marker: unknown column has correct span"
        input <<STYX
            BadQuery @select{
                from product
                where {deleted_at @null}
                fields {
                    id
                    bad_column
                    ^^^^^^^^^^ "Unknown column"
                }
            }
            STYX
    }

    {
        name "span marker: wrong span is detected (negative test)"
        expect_fail true
        input <<STYX
            BadQuery @select{
                from nonexistent
            ^ "Unknown table"
            }
            STYX
        diagnostics {count 1}
    }

    {
        name "span marker: wrong message is detected (negative test)"
        expect_fail true
        input <<STYX
            BadQuery @select{
                from nonexistent
                     ^^^^^^^^^^^ "THIS MESSAGE DOES NOT EXIST"
            }
            STYX
        diagnostics {count 1}
    }

    {
        name "lint: redundant param reference in where"
        input <<STYX
            QueryById @select{
                from product
                params {id @int}
                where {deleted_at @null, id $id}
                fields {handle}
            }
            STYX
        diagnostics {
            count 1
            has ({message "can be shortened", code "redundant-param"})
        }
    }

    {
        name "lint: no warning when param name differs from column"
        input <<STYX
            InsertProduct @insert{
                into product
                params {new_handle @string}
                values {handle $new_handle}
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: redundant param in upsert values"
        input <<STYX
            UpsertProduct @upsert{
                into product
                params {handle @string, status @string}
                values {
                    handle $handle
                    status $status
                }
                on-conflict {
                    target {id}
                    update {status $status}
                }
            }
            STYX
        diagnostics {
            count 3
            has (
                {message "handle $handle", code "redundant-param"}
                {message "status $status", code "redundant-param"}
            )
        }
    }

    // ========================================================================
    // Bulk Insert/Upsert Tests (@insert-many, @upsert-many)
    // ========================================================================

    {
        name "inlay hints in insert-many values block"
        input <<STYX
            BulkCreateProducts @insert-many{
                params {handle @string, status @string}
                into product
                values {
                    handle $handle
                    status $status
                }
            }
            STYX
        inlay_hints {
            count 2
            has (
                {label ": TEXT", line 5}
                {label ": TEXT", line 6}
            )
        }
    }

    {
        name "inlay hints in insert-many returning block"
        input <<STYX
            BulkCreateProducts @insert-many{
                params {handle @string, status @string}
                into product
                values {handle $handle, status $status}
                returning {id, handle}
            }
            STYX
        inlay_hints {
            count 4
            has (
                {label ": TEXT", line 4}
                {label ": TEXT", line 4}
                {label ": BIGINT", line 5}
                {label ": TEXT", line 5}
            )
        }
    }

    {
        name "inlay hints in upsert-many values block"
        input <<STYX
            BulkUpsertProducts @upsert-many{
                params {handle @string, status @string}
                into product
                on-conflict {
                    target {handle}
                    update {status}
                }
                values {
                    handle $handle
                    status $status
                }
            }
            STYX
        inlay_hints {
            count 4
            has (
                {label ": TEXT", line 5}
                {label ": TEXT", line 6}
                {label ": TEXT", line 9}
                {label ": TEXT", line 10}
            )
        }
    }

    {
        name "lint: redundant param in insert-many values"
        input <<STYX
            BulkCreate @insert-many{
                params {handle @string, status @string}
                into product
                values {
                    handle $handle
                    status $status
                }
            }
            STYX
        diagnostics {
            count 2
            has (
                {message "handle $handle", code "redundant-param"}
                {message "status $status", code "redundant-param"}
            )
        }
    }

    {
        name "lint: redundant param in upsert-many values"
        input <<STYX
            BulkUpsert @upsert-many{
                params {handle @string, status @string}
                into product
                on-conflict {
                    target {handle}
                    update {status $status}
                }
                values {
                    handle $handle
                    status $status
                }
            }
            STYX
        diagnostics {
            count 3
            has (
                {message "handle $handle", code "redundant-param"}
                {message "status $status", code "redundant-param"}
            )
        }
    }

    {
        name "lint: unused param in insert-many"
        input <<STYX
            BulkCreate @insert-many{
                params {handle @string, unused @string}
                into product
                values {handle}
            }
            STYX
        diagnostics {
            count 1
            has ({message "param 'unused' is declared but never used", code "unused-param"})
        }
    }

    {
        name "lint: unknown table in insert-many"
        input <<STYX
            BulkCreate @insert-many{
                params {handle @string}
                into nonexistent_table
                     ^^^^^^^^^^^^^^^^^ "Unknown table"
                values {handle}
            }
            STYX
        diagnostics {
            count 1
            has ({message "Unknown table", code "unknown-table"})
        }
    }
)
